<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <title>Chat Room</title>
    <style>
        body {
            background-color: #1e1e1e;
        }

        .messages {
            overflow-y: scroll;
        }

        .messages::-webkit-scrollbar {
            width: 0px;
            height: 0px;
        }

        .messages::-webkit-scrollbar-thumb {
            background: transparent;
        }

        .chat {
            cursor: pointer;
        }

        .input-container {
            background-color: #1c1c1c;
            padding: 10px;
        }
    </style>
</head>

<body class="text-white">

    <div class="main d-flex" style="height: 100vh;">
        <!-- Sidebar -->
        <div class="sidebar col-xl-3 col-md-4 d-flex flex-column h-100" style="background-color: #222; height: 100vh;">
            <div class="row px-3 text-center pt-3">
                <h5>Chats</h5>
            </div>
            <div class="row pb-3 px-3 border-bottom">
                <div class="w-100 p-2 rounded" style="background-color: #444;">
                    <div class="input-group bg-transparent">
                        <i class="input-group-text bi bi-search bg-transparent text-white border-0"></i>
                        <input class="form-control border-0 shadow-none text-white" style="background-color: #444;"
                            placeholder="Search" type="text" />
                    </div>
                </div>
            </div>
            <!-- Chat Items  -->
            <div class="flex-grow-1" style="overflow-x: hide; background-color: #222;">
                <div class="row chat current" style="background-color: #444;">
                    <div class="w-100 py-3 px-4 border-bottom">
                        Chat 1
                    </div>
                </div>
                <div class="row chat">
                    <div class="w-100 py-3 px-4 border-bottom">
                        Chat 2
                    </div>
                </div>
                <div class="row chat">
                    <div class="w-100 py-3 px-4 border-bottom">
                        Chat 3
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Chat Content -->
        <div class="content col-12 col-xl-9 col-md-8 d-none d-md-flex flex-column h-100 p-0">
            <div class="header-main p-3">
                <h5 class="back-header"><i class="back-icon bi bi-arrow-left mr-2 d-md-none"></i>Chat 1</h5>
            </div>

            <div class="messages-container p-4 flex-grow-1" style="background-color: #262626;">
                <div class="messages d-flex flex-column" style="overflow-y: auto;">
                    <!-- Messages will go here -->
                </div>
            </div>

            <!-- Chat Footer with Input -->
            <div class="input-container p-3" style="background-color: #1c1c1c;">
                <div class="input-group rounded p-2" style="background-color: #333;">
                    <!-- Input Field -->
                    <input type="text" id="message-input" class="form-control border-0 shadow-none text-white"
                        placeholder="Type a message" style="background-color: #333" />
                    <!-- Send Button -->
                    <button id="send-button" class="input-group-text rounded-circle ml-2 border-0 text-white"
                        style="background-color: #2980b9">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            const url = "https://eubcmsrzozacnsqtwpbq.supabase.co";
            const anon_key = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1YmNtc3J6b3phY25zcXR3cGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg4NjgxMzAsImV4cCI6MjA1NDQ0NDEzMH0.AYQtVVa-uDSxfKrJmr4ExCiE9g_5eYrMalstI8P6h2s";
            const supabaseClient = supabase.createClient(url, anon_key);
            const channel = supabaseClient.channel("chatroom");

            // Show/Hide chatroom functionality
            $(".chat").click(function () {
                $(".current").css("background-color", "#222").removeClass("current");
                $(this).addClass("current").css("background-color", "#444");
                const content = $(".content");
                if (content.hasClass("d-none")) {
                    const sidebar = $(".sidebar");
                    content.removeClass("d-none").removeClass("d-md-flex").addClass("d-flex");
                    sidebar.addClass("d-none").removeClass("d-flex").addClass("d-md-flex");
                }
            });

            $(".back-icon").click(function () {
                const content = $(".content");
                const sidebar = $(".sidebar");
                sidebar.removeClass("d-none").removeClass("d-md-flex").addClass("d-flex");
                content.addClass("d-none").removeClass("d-md-flex").addClass("d-flex");
            });

            // Dynamic height for messages container
            $(window).on('load resize', function () {
                const containerHeight = $(window).height() - $(".header-main").outerHeight() - $(".input-container").outerHeight();
                $(".messages-container").css("height", containerHeight);
                const maxMessagesHeight = $(".messages-container").innerHeight() - 50;
                $(".messages").css("max-height", maxMessagesHeight);
            });

            // Sending message via "Enter" key
            $("#message-input").keydown(function (event) {
                if (event.keyCode === 13) {
                    event.preventDefault();
                    sendMessage();
                }
            });

            // Send message button click
            $("#send-button").click(sendMessage);

            // Function to send a message
            function sendMessage() {
                const inputMessage = $("#message-input");

                if (inputMessage.val() != "") {
                    const newMessage = document.createElement('div');
                    newMessage.classList.add('message', 'p-2', 'my-2', 'bg-primary', 'rounded');
                    newMessage.style.display = 'inline-block';
                    newMessage.style.width = 'auto';

                    const messageContent = document.createElement('div');
                    messageContent.classList.add('p-1');
                    messageContent.textContent = inputMessage.val();

                    newMessage.style.alignSelf = 'flex-end';
                    newMessage.style.maxWidth = '90%';
                    newMessage.style.wordWrap = 'break-word';
                    newMessage.style.overflowWrap = 'break-word';

                    newMessage.appendChild(messageContent);
                    $(".messages").append(newMessage);
                    $(".messages").scrollTop($(".messages")[0].scrollHeight);

                    // Insert message into Supabase
                    messageValue = inputMessage.val();
                    supabaseClient
                        .from('messages')
                        .insert([{ sender: 'user', message: messageValue, chat_id: 'Chat 1' }])
                        .then(() => {
                            channel.send({
                                type: "broadcast",
                                event: "new-message",
                                payload: { message: messageValue, sender: 'user' },
                            });
                        })
                        .catch(console.error);

                    inputMessage.val("");
                }
            }

            // Real-time message handling (broadcast)
            channel.on('broadcast', { event: 'new-message' }, (data) => {
                const { message, sender } = data.payload;
                const newMessage = document.createElement('div');
                newMessage.classList.add('message', 'p-2', 'my-2', 'bg-success', 'rounded');
                newMessage.style.display = 'inline-block';
                newMessage.style.width = 'auto';

                const messageContent = document.createElement('div');
                messageContent.classList.add('p-1');
                messageContent.textContent = message;

                newMessage.style.alignSelf = 'flex-start';
                newMessage.style.maxWidth = '90%';
                newMessage.style.wordWrap = 'break-word';
                newMessage.style.overflowWrap = 'break-word';

                newMessage.appendChild(messageContent);
                $(".messages").append(newMessage);
                $(".messages").scrollTop($(".messages")[0].scrollHeight);
            }).subscribe();

            function fetchMessages() { //chatId
                supabaseClient
                    .from('messages')
                    .select('*')
                    //.eq('chat_id', chatId)
                    .order('created_at', { ascending: true })
                    .then(({ data, error }) => {
                        if (error) {
                            console.error(error);
                            return;
                        }

                        $(".messages").empty();
                        data.forEach((msg) => {
                            const newMessage = document.createElement('div');
                            newMessage.classList.add('message', 'p-2', 'my-2', 'bg-primary', 'rounded');
                            newMessage.style.display = 'inline-block';
                            newMessage.style.width = 'auto';

                            const messageContent = document.createElement('div');
                            messageContent.classList.add('p-1');
                            messageContent.textContent = msg.message;

                            newMessage.style.alignSelf = 'flex-start';
                            newMessage.style.maxWidth = '90%';
                            newMessage.style.wordWrap = 'break-word';
                            newMessage.style.overflowWrap = 'break-word';

                            newMessage.appendChild(messageContent);
                            $(".messages").append(newMessage);
                        });

                        $(".messages").scrollTop($(".messages")[0].scrollHeight);
                    })
                    .catch(console.error);
            }

            fetchMessages();
        });
    </script>

</body>

</html>